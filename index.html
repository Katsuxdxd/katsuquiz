<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pruebas - Plataforma Educativa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            color: white;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, textarea, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5f2;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus, button:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin: 5px 0;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-csv {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }
        
        .hidden {
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        
        /* Estilos para el panel del docente */
        .teacher-login, .teacher-dashboard {
            /* Estilos ya definidos arriba */
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5f2;
        }
        
        .teacher-info {
            font-weight: bold;
            color: #2d3748;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 0;
        }
        
        .exams-list {
            margin: 15px 0;
            border: 2px solid #e1e5f2;
            border-radius: 10px;
            padding: 10px;
        }
        
        .exam-item {
            background: #f8f9ff;
            padding: 15px;
            margin: 8px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e5f2;
        }
        
        .exam-title {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .exam-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            width: auto;
            min-width: 70px;
        }
        
        .exam-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e1e5f2;
            max-height: 800px;
            min-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #fafbff;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        /* Estilos para el panel del alumno - manteniendo como estaba */
        .student-test-container {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .question-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .question-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #2d3748;
            font-weight: 500;
            margin: 15px 0;
            text-align: center;
        }
        
        .options-grid {
            display: grid;
            gap: 12px;
            margin: 25px 0;
        }
        
        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f0f7ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .option-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .option-label {
            flex: 1;
            font-size: 1.1rem;
            color: #4a5568;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .multiple-hint {
            text-align: center;
            color: #e53e3e;
            font-style: italic;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .single-hint {
            text-align: center;
            color: #3182ce;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .progress-indicator {
            text-align: center;
            color: #718096;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .timer-container {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .timer-warning {
            background: linear-gradient(135deg, #ff8e53 0%, #ff6b6b 100%);
        }
        
        .student-login-form {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e1e5f2;
        }
        
        .student-login-form h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .answers-section {
            display: none;
        }
        
        .answers-section.active {
            display: block;
        }
        
        .answers-list {
            margin-top: 20px;
        }
        
        .answer-item {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .answer-question-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .answer-result {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .answer-result.correct {
            color: #38a169;
        }
        
        .answer-result.incorrect {
            color: #e53e3e;
        }
        
        .answer-content {
            line-height: 1.6;
        }
        
        .answer-content strong {
            color: #2d3748;
        }
        
        .test-result {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(72, 187, 120, 0.4);
        }
        
        .test-result h4 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .test-percentage {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .rankings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e1e5f2;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9ff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .ranking-position {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .ranking-name {
            flex: 1;
            margin: 0 15px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .ranking-score {
            background: #48bb78;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .csv-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .options-container {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px solid #e1e5f2;
        }
        
        .option-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .option-input-text {
            flex: 1;
            min-width: 0;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .correct-checkbox {
            margin: 0;
            width: 18px;
            height: 18px;
        }
        
        .delete-option-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .delete-option-btn:hover {
            background: #ff5252;
        }
        
        .time-settings, .general-settings {
            margin: 15px 0;
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e1e5f2;
        }
        
        .toggle-section {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            border: 2px solid #e1e5f2;
        }
        
        .questions-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 2px solid #e1e5f2;
            border-radius: 10px;
            padding: 10px;
        }
        
        .question-item {
            background: #f8f9ff;
            padding: 12px;
            margin: 6px 0;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            position: relative;
        }
        
        .question-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }
        
        .question-action-btn {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 4px;
            width: auto;
            min-width: 40px;
        }
        
        .question-content {
            margin-right: 60px;
        }
        
        .question-content h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .question-content p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .correct-answer {
            color: #28a745;
            font-weight: bold;
        }
        
        .multiple-choice {
            color: #dc3545;
            font-style: italic;
        }
        
        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .participants-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e1e5f2;
        }
        
        .participants-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .participant-item {
            background: #f8f9ff;
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .participant-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 14px;
        }
        
        .participant-time {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }
        
        /* Mensajes del docente */
        .teacher-message-area {
            margin: 15px 0;
        }
        
        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Sistema de Pruebas Educativo</h1>
            <p>Plataforma completa para docentes y alumnos</p>
        </header>
        
        <div class="app-container">
            <!-- Panel del Docente -->
            <div class="panel">
                <div id="teacherLogin" class="teacher-login">
                    <h2>üë®‚Äçüè´ Inicio de Sesi√≥n - Docente</h2>
                    <div class="form-group">
                        <label for="teacherEmail">Correo Electr√≥nico:</label>
                        <input type="email" id="teacherEmail" placeholder="profesor@escuela.edu">
                    </div>
                    <div class="form-group">
                        <label for="teacherPassword">Contrase√±a:</label>
                        <input type="password" id="teacherPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="rememberTeacher"> Recordar mi usuario
                        </label>
                    </div>
                    <button id="loginTeacher" class="btn">üîê Iniciar Sesi√≥n</button>
                    <button id="registerTeacher" class="btn btn-success">üìù Registrarse</button>
                </div>
                
                <div id="teacherDashboard" class="teacher-dashboard hidden">
                    <div class="dashboard-header">
                        <div class="teacher-info" id="teacherInfo">Bienvenido, profesor@ejemplo.com</div>
                        <button id="logoutTeacher" class="btn logout-btn">üö™ Cerrar Sesi√≥n</button>
                    </div>
                    
                    <div class="teacher-message-area" id="teacherMessageArea"></div>
                    
                    <div class="form-group">
                        <label for="examName">Nombre del Examen:</label>
                        <input type="text" id="examName" placeholder="Examen de Matem√°ticas Unidad 1">
                    </div>
                    <button id="createExam" class="btn btn-success">‚ûï Crear Nuevo Examen</button>
                    
                    <h3>üìã Mis Ex√°menes</h3>
                    <div class="exams-list" id="examsList">
                        <div class="loading">Cargando datos...</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel del Alumno -->
            <div class="panel">
                <h2>üéì Acceso del Alumno</h2>
                <div class="student-login-form">
                    <h3>üìù Inicio de Sesi√≥n</h3>
                    <div class="form-group">
                        <label for="studentName">Tu nombre completo:</label>
                        <input type="text" id="studentName" placeholder="Ej: Juan P√©rez">
                    </div>
                    <div class="form-group">
                        <label for="accessCode">C√≥digo del examen:</label>
                        <input type="text" id="accessCode" placeholder="Ej: ABC123">
                    </div>
                    <button id="accessTest" class="btn">üîì Iniciar Examen</button>
                </div>
                
                <div id="messageArea"></div>
                
                <div id="testInterface" class="hidden">
                    <div class="student-test-container">
                        <div class="timer-container" id="timerDisplay">Tiempo restante: 00:20</div>
                        <div class="progress-indicator" id="progressIndicator"></div>
                        <div class="question-header">
                            <div class="question-number" id="questionNumber"></div>
                            <div class="question-text" id="currentQuestionText"></div>
                        </div>
                        <div id="typeHint"></div>
                        <div class="options-grid" id="studentOptionsContainer"></div>
                        <button id="submitButton" class="btn">‚úÖ Enviar Respuesta</button>
                    </div>
                </div>
                
                <div id="answersSection" class="answers-section">
                    <h3>üìã Tu Resultado Detallado</h3>
                    <div id="answersList" class="answers-list"></div>
                    <div id="testResult" class="test-result"></div>
                    
                    <div id="studentRankingsSection" class="rankings-section hidden">
                        <h3>üìä Clasificaci√≥n General</h3>
                        <div class="participants-list" id="studentRankingsList">
                            <p style="text-align: center; color: #666; padding: 10px;">La clasificaci√≥n se mostrar√° despu√©s de finalizar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // CONFIGURACI√ìN DE GITHUB GIST - USANDO TUS CREDENCIALES
        const GIST_ID = '293291f181d26aa76b2b9578e22e6257';
        const GITHUB_TOKEN = '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';
        
        // URLs para el Gist
        const GIST_READ_URL = `https://gist.githubusercontent.com/Katsuxdxd/${GIST_ID}/raw`;
        const GIST_API_URL = `https://api.github.com/gists/${GIST_ID}`;
        
        // Variables globales
        let teachers = {};
        let currentTeacher = null;
        let currentExam = null;
        let questionsBank = {};
        let testCode = '';
        let studentAnswers = [];
        let currentQuestionIndex = 0;
        let studentName = '';
        let questionTimer = null;
        let testSettings = {};
        let expandedExam = null;
        let rememberTeacherChecked = false;
        let isSaving = false; // Prevenir m√∫ltiples guardados simult√°neos
        
        // Elementos del DOM
        const teacherEmail = document.getElementById('teacherEmail');
        const teacherPassword = document.getElementById('teacherPassword');
        const rememberTeacher = document.getElementById('rememberTeacher');
        const loginTeacherBtn = document.getElementById('loginTeacher');
        const registerTeacherBtn = document.getElementById('registerTeacher');
        const teacherLogin = document.getElementById('teacherLogin');
        const teacherDashboard = document.getElementById('teacherDashboard');
        const teacherInfo = document.getElementById('teacherInfo');
        const logoutTeacherBtn = document.getElementById('logoutTeacher');
        const teacherMessageArea = document.getElementById('teacherMessageArea');
        const examName = document.getElementById('examName');
        const createExamBtn = document.getElementById('createExam');
        const examsList = document.getElementById('examsList');
        const studentNameInput = document.getElementById('studentName');
        const accessCodeInput = document.getElementById('accessCode');
        const accessTestBtn = document.getElementById('accessTest');
        const messageArea = document.getElementById('messageArea');
        const testInterface = document.getElementById('testInterface');
        const currentQuestionText = document.getElementById('currentQuestionText');
        const questionNumber = document.getElementById('questionNumber');
        const progressIndicator = document.getElementById('progressIndicator');
        const typeHint = document.getElementById('typeHint');
        const studentOptionsContainer = document.getElementById('studentOptionsContainer');
        const submitButton = document.getElementById('submitButton');
        const answersSection = document.getElementById('answersSection');
        const answersList = document.getElementById('answersList');
        const testResult = document.getElementById('testResult');
        const timerDisplay = document.getElementById('timerDisplay');
        const studentRankingsSection = document.getElementById('studentRankingsSection');
        const studentRankingsList = document.getElementById('studentRankingsList');
        
        // Funciones para manejar el almacenamiento en Gist
        async function loadTeachersFromGist() {
            try {
                const response = await fetch(GIST_READ_URL + '?_=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    return data.teachers || {};
                } else {
                    console.error('Error al cargar el Gist:', response.status);
                    return {};
                }
            } catch (e) {
                console.error('Error al cargar datos desde Gist:', e);
                return {};
            }
        }
        
        async function saveTeachersToGist(teachersData) {
            if (isSaving) return; // Evitar guardados m√∫ltiples
            isSaving = true;
            
            try {
                const data = {
                    description: "Datos de ex√°menes educativos - Sistema de Pruebas",
                    public: true,
                    files: {
                        "exam-data.json": {
                            content: JSON.stringify({ teachers: teachersData }, null, 2)
                        }
                    }
                };
                
                const response = await fetch(GIST_API_URL, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'ExamSystem/1.0'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
            } catch (e) {
                console.error('Error al guardar en Gist:', e);
                showMessage('Error al guardar los datos. Verifica tu conexi√≥n.', 'error', true);
            } finally {
                isSaving = false;
            }
        }
        
        // Funci√≥n para a√±adir opci√≥n
        function addOption(container, placeholder = '', checked = false) {
            const optionRow = document.createElement('div');
            optionRow.className = 'option-row';
            
            optionRow.innerHTML = `
                <input type="text" class="option-input-text" placeholder="${placeholder}" value="${placeholder}">
                <input type="checkbox" class="correct-checkbox" ${checked ? 'checked' : ''}>
                <button type="button" class="delete-option-btn" title="Eliminar opci√≥n">‚úï</button>
            `;
            
            const deleteBtn = optionRow.querySelector('.delete-option-btn');
            deleteBtn.onclick = () => {
                if (container.querySelectorAll('.option-row').length > 2) {
                    container.removeChild(optionRow);
                } else {
                    showMessage('Debe haber al menos 2 opciones', 'error');
                }
            };
            
            container.appendChild(optionRow);
        }
        
        // Inicializar con 4 opciones por defecto
        function initializeOptions(container) {
            container.innerHTML = '';
            addOption(container, 'Opci√≥n 1', false);
            addOption(container, 'Opci√≥n 2', false);
            addOption(container, 'Opci√≥n 3', false);
            addOption(container, 'Opci√≥n 4', false);
        }
        
        // Mostrar mensaje
        function showMessage(message, type, isTeacher = false) {
            const targetArea = isTeacher ? teacherMessageArea : messageArea;
            targetArea.innerHTML = `
                <div class="${type === 'success' ? 'success-message' : 'error-message'}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                targetArea.innerHTML = '';
            }, 5000);
        }
        
        // Registro de docente
        registerTeacherBtn.addEventListener('click', async () => {
            const email = teacherEmail.value.trim();
            const password = teacherPassword.value.trim();
            
            if (!email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showMessage('Por favor ingresa un correo v√°lido', 'error');
                return;
            }
            
            if (teachers[email]) {
                showMessage('Este correo ya est√° registrado', 'error');
                return;
            }
            
            teachers[email] = {
                email: email,
                password: password,
                exams: {}
            };
            
            currentTeacher = email;
            rememberTeacherChecked = rememberTeacher.checked;
            await saveTeachersToGist(teachers);
            loadTeacherDashboard();
            showMessage('Registro exitoso! Bienvenido.', 'success');
        });
        
        // Inicio de sesi√≥n de docente
        loginTeacherBtn.addEventListener('click', async () => {
            const email = teacherEmail.value.trim();
            const password = teacherPassword.value.trim();
            
            if (!email || !password) {
                showMessage('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (teachers[email] && teachers[email].password === password) {
                currentTeacher = email;
                rememberTeacherChecked = rememberTeacher.checked;
                loadTeacherDashboard();
                showMessage('Inicio de sesi√≥n exitoso', 'success');
            } else {
                showMessage('Credenciales incorrectas', 'error');
            }
        });
        
        // Cerrar sesi√≥n
        logoutTeacherBtn.addEventListener('click', () => {
            currentTeacher = null;
            teacherDashboard.classList.add('hidden');
            teacherLogin.classList.remove('hidden');
            teacherEmail.value = '';
            teacherPassword.value = '';
            rememberTeacher.checked = false;
            showMessage('Sesi√≥n cerrada exitosamente', 'success', true);
        });
        
        // Cargar dashboard del docente
        function loadTeacherDashboard() {
            teacherLogin.classList.add('hidden');
            teacherDashboard.classList.remove('hidden');
            teacherInfo.textContent = `Bienvenido, ${currentTeacher}`;
            updateExamsList();
        }
        
        // Actualizar lista de ex√°menes
        function updateExamsList() {
            if (!currentTeacher || !teachers[currentTeacher]) {
                examsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No tienes ex√°menes creados</p>';
                return;
            }
            
            const teacherExams = teachers[currentTeacher].exams;
            if (Object.keys(teacherExams).length === 0) {
                examsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No tienes ex√°menes creados</p>';
                return;
            }
            
            examsList.innerHTML = '';
            Object.keys(teacherExams).forEach(examId => {
                const exam = teacherExams[examId];
                const examDiv = document.createElement('div');
                examDiv.className = 'exam-item';
                examDiv.dataset.id = examId;
                
                const examHeader = document.createElement('div');
                examHeader.className = 'exam-header';
                examHeader.innerHTML = `
                    <div class="exam-title">${exam.name}</div>
                    <div class="exam-actions">
                        <button class="btn btn-success action-btn edit-exam" data-id="${examId}">‚úèÔ∏è Editar</button>
                        <button class="btn btn-warning action-btn delete-exam" data-id="${examId}">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                examDiv.appendChild(examHeader);
                
                const examContent = document.createElement('div');
                examContent.className = 'exam-content hidden';
                examContent.id = `exam-content-${examId}`;
                examDiv.appendChild(examContent);
                
                examsList.appendChild(examDiv);
                
                examHeader.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-btn')) {
                        toggleExamContent(examId);
                    }
                });
                
                examHeader.querySelector('.edit-exam').onclick = (e) => {
                    e.stopPropagation();
                    editExam(examId);
                };
                
                examHeader.querySelector('.delete-exam').onclick = (e) => {
                    e.stopPropagation();
                    deleteExam(examId);
                };
            });
        }
        
        // Alternar contenido del examen
        function toggleExamContent(examId) {
            if (expandedExam === examId) {
                expandedExam = null;
                document.getElementById(`exam-content-${examId}`).classList.add('hidden');
            } else {
                if (expandedExam) {
                    document.getElementById(`exam-content-${expandedExam}`).classList.add('hidden');
                }
                expandedExam = examId;
                document.getElementById(`exam-content-${examId}`).classList.remove('hidden');
                loadExamContent(examId);
            }
        }
        
        // Cargar contenido del examen
        function loadExamContent(examId) {
            const contentDiv = document.getElementById(`exam-content-${examId}`);
            if (contentDiv.innerHTML !== '') return;
            
            const exam = teachers[currentTeacher].exams[examId];
            
            contentDiv.innerHTML = `
                <div class="questions-list" id="questions-list-${examId}">
                    <p style="text-align: center; color: #666; padding: 10px;">No hay preguntas en este examen</p>
                </div>
                
                <div class="form-group">
                    <label for="question-${examId}">Pregunta:</label>
                    <textarea id="question-${examId}" placeholder="Escribe tu pregunta"></textarea>
                </div>
                <div class="form-group">
                    <label>Opciones y Respuestas Correctas:</label>
                    <div id="options-container-${examId}" class="options-container"></div>
                </div>
                <div class="time-settings">
                    <div class="form-group">
                        <label for="question-time-${examId}">Tiempo por pregunta (segundos):</label>
                        <input type="number" id="question-time-${examId}" min="10" max="300" value="20">
                    </div>
                </div>
                <div class="form-group">
                    <button id="add-option-${examId}" class="btn btn-success">‚ûï A√±adir Opci√≥n</button>
                    <button id="add-question-${examId}" class="btn">‚úÖ A√±adir Pregunta</button>
                </div>
                
                <div class="general-settings">
                    <div class="form-group">
                        <label for="start-date-${examId}">Fecha/hora de inicio:</label>
                        <input type="datetime-local" id="start-date-${examId}">
                    </div>
                    <div class="form-group">
                        <label for="end-date-${examId}">Fecha/hora de cierre:</label>
                        <input type="datetime-local" id="end-date-${examId}">
                    </div>
                </div>
                
                <div class="toggle-section">
                    <label>
                        <input type="checkbox" id="show-rankings-${examId}"> 
                        Mostrar clasificaci√≥n a los alumnos
                    </label>
                </div>
                
                <div class="code-display" id="test-code-${examId}">C√ìDIGO: ESPERE...</div>
                <button id="generate-test-${examId}" class="btn btn-secondary">üöÄ Generar Examen</button>
                
                <div class="participants-section">
                    <h3>üë• Participantes Finalizados</h3>
                    <div class="participants-list" id="participants-list-${examId}">
                        <p style="text-align: center; color: #666; padding: 10px;">No hay participantes a√∫n</p>
                    </div>
                    <div class="csv-section">
                        <button id="export-csv-${examId}" class="btn btn-csv">üìä Exportar Resultados a CSV</button>
                    </div>
                </div>
                
                <div class="rankings-section">
                    <h3>ü•á Clasificaci√≥n Final</h3>
                    <div class="participants-list" id="rankings-list-${examId}">
                        <p style="text-align: center; color: #666; padding: 10px;">Sin clasificaci√≥n a√∫n</p>
                    </div>
                </div>
            `;
            
            // Inicializar opciones
            const optionsContainer = document.getElementById(`options-container-${examId}`);
            initializeOptions(optionsContainer);
            
            // Configurar fechas
            const startDateInput = document.getElementById(`start-date-${examId}`);
            const endDateInput = document.getElementById(`end-date-${examId}`);
            
            if (exam.settings && exam.settings.startDate) {
                startDateInput.value = formatDateTimeLocal(new Date(exam.settings.startDate));
            } else {
                const now = new Date();
                const startDate = new Date(now.getTime() + 60000);
                startDateInput.value = formatDateTimeLocal(startDate);
            }
            
            if (exam.settings && exam.settings.endDate) {
                endDateInput.value = formatDateTimeLocal(new Date(exam.settings.endDate));
            } else {
                const now = new Date();
                const endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                endDateInput.value = formatDateTimeLocal(endDate);
            }
            
            // Cargar preguntas
            displayQuestions(examId);
            
            // Configurar eventos
            document.getElementById(`add-option-${examId}`).onclick = () => {
                const optionNumber = optionsContainer.querySelectorAll('.option-row').length + 1;
                addOption(optionsContainer, `Opci√≥n ${optionNumber}`, false);
            };
            
            document.getElementById(`add-question-${examId}`).onclick = () => addQuestionToExam(examId);
            document.getElementById(`generate-test-${examId}`).onclick = () => generateTest(examId);
            document.getElementById(`export-csv-${examId}`).onclick = () => exportCSV(examId);
            
            // Cargar configuraci√≥n
            if (exam.settings) {
                document.getElementById(`question-time-${examId}`).value = exam.settings.questionTime || 20;
                document.getElementById(`show-rankings-${examId}`).checked = exam.settings.showRankings || false;
            }
            
            if (exam.code) {
                document.getElementById(`test-code-${examId}`).textContent = `C√ìDIGO: ${exam.code}`;
            }
        }
        
        // A√±adir pregunta al examen
        async function addQuestionToExam(examId) {
            const questionInput = document.getElementById(`question-${examId}`);
            const optionsContainer = document.getElementById(`options-container-${examId}`);
            const questionTimeInput = document.getElementById(`question-time-${examId}`);
            
            const question = questionInput.value.trim();
            const optionRows = optionsContainer.querySelectorAll('.option-row');
            
            if (!question) {
                showMessage('Por favor escribe una pregunta', 'error', true);
                return;
            }
            
            const options = [];
            const correctAnswers = [];
            
            optionRows.forEach((row, index) => {
                const input = row.querySelector('.option-input-text');
                const checkbox = row.querySelector('.correct-checkbox');
                const option = input.value.trim();
                
                if (!option) {
                    showMessage(`La opci√≥n ${index + 1} no puede estar vac√≠a`, 'error', true);
                    return;
                }
                
                options.push(option);
                if (checkbox.checked) {
                    correctAnswers.push(option);
                }
            });
            
            if (options.length < 2) {
                showMessage('Debe haber al menos 2 opciones', 'error', true);
                return;
            }
            
            if (correctAnswers.length === 0) {
                showMessage('Debes seleccionar al menos una respuesta correcta', 'error', true);
                return;
            }
            
            const newQuestion = {
                id: Date.now(),
                question: question,
                options: options,
                correctAnswers: correctAnswers,
                time: parseInt(questionTimeInput.value) || 20
            };
            
            if (!teachers[currentTeacher].exams[examId].questions) {
                teachers[currentTeacher].exams[examId].questions = [];
            }
            
            teachers[currentTeacher].exams[examId].questions.push(newQuestion);
            await saveTeachersToGist(teachers);
            displayQuestions(examId);
            questionInput.value = '';
            initializeOptions(optionsContainer);
            showMessage('Pregunta a√±adida al examen exitosamente', 'success', true);
        }
        
        // Mostrar preguntas
        function displayQuestions(examId) {
            const questionsList = document.getElementById(`questions-list-${examId}`);
            const exam = teachers[currentTeacher].exams[examId];
            const questions = exam.questions || [];
            
            if (questions.length === 0) {
                questionsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No hay preguntas en este examen</p>';
                return;
            }
            
            questionsList.innerHTML = '';
            questions.forEach(q => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.dataset.id = q.id;
                
                const isMultiple = q.correctAnswers.length > 1;
                const correctAnswersHtml = q.correctAnswers.map(ans => `<span class="correct-answer">${ans}</span>`).join(', ');
                
                questionDiv.innerHTML = `
                    <div class="question-actions">
                        <button class="btn btn-success question-action-btn edit-btn" title="Editar">‚úèÔ∏è</button>
                        <button class="btn btn-warning question-action-btn delete-btn" title="Eliminar">üóëÔ∏è</button>
                    </div>
                    <div class="question-content">
                        <h4>${q.question}</h4>
                        <p><strong>Opciones:</strong> ${q.options.join(', ')}</p>
                        <p><strong>Respuesta(s) correcta(s):</strong> ${correctAnswersHtml}</p>
                        <p><strong>Tiempo:</strong> ${q.time} segundos | ${isMultiple ? '<span class="multiple-choice">M√∫ltiple</span>' : '√önica'}</p>
                    </div>
                `;
                
                questionsList.appendChild(questionDiv);
                
                questionDiv.querySelector('.edit-btn').onclick = () => editQuestion(examId, q.id);
                questionDiv.querySelector('.delete-btn').onclick = () => deleteQuestion(examId, q.id);
            });
        }
        
        // Editar pregunta
        async function editQuestion(examId, questionId) {
            const exam = teachers[currentTeacher].exams[examId];
            const question = exam.questions.find(q => q.id === questionId);
            if (!question) return;
            
            const questionInput = document.getElementById(`question-${examId}`);
            const optionsContainer = document.getElementById(`options-container-${examId}`);
            const questionTimeInput = document.getElementById(`question-time-${examId}`);
            
            questionInput.value = question.question;
            optionsContainer.innerHTML = '';
            
            question.options.forEach(option => {
                const isChecked = question.correctAnswers.includes(option);
                addOption(optionsContainer, option, isChecked);
            });
            
            // Si hay menos de 4 opciones, completar hasta 4
            const existingOptions = question.options.length;
            for (let i = existingOptions; i < 4; i++) {
                addOption(optionsContainer, `Opci√≥n ${i + 1}`, false);
            }
            
            questionTimeInput.value = question.time || 20;
            
            // Eliminar la pregunta original
            exam.questions = exam.questions.filter(q => q.id !== questionId);
            await saveTeachersToGist(teachers);
            displayQuestions(examId);
        }
        
        // Eliminar pregunta
        async function deleteQuestion(examId, questionId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta pregunta?')) {
                const exam = teachers[currentTeacher].exams[examId];
                exam.questions = exam.questions.filter(q => q.id !== questionId);
                await saveTeachersToGist(teachers);
                displayQuestions(examId);
                showMessage('Pregunta eliminada exitosamente', 'success', true);
            }
        }
        
        // Crear nuevo examen
        async function createExam() {
            const name = examName.value.trim();
            if (!name) {
                showMessage('Por favor ingresa un nombre para el examen', 'error', true);
                return;
            }
            
            const examId = Date.now().toString();
            if (!teachers[currentTeacher].exams) {
                teachers[currentTeacher].exams = {};
            }
            
            teachers[currentTeacher].exams[examId] = {
                id: examId,
                name: name,
                questions: [],
                settings: {
                    questionTime: 20,
                    startDate: null,
                    endDate: null,
                    showRankings: false
                },
                code: '',
                participants: []
            };
            
            await saveTeachersToGist(teachers);
            updateExamsList();
            examName.value = '';
            showMessage('Examen creado exitosamente', 'success', true);
        }
        
        createExamBtn.addEventListener('click', createExam);
        
        // Editar examen
        function editExam(examId) {
            if (expandedExam !== examId) {
                toggleExamContent(examId);
            }
        }
        
        // Eliminar examen
        async function deleteExam(examId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este examen?')) {
                delete teachers[currentTeacher].exams[examId];
                if (expandedExam === examId) {
                    expandedExam = null;
                }
                await saveTeachersToGist(teachers);
                updateExamsList();
                showMessage('Examen eliminado exitosamente', 'success', true);
            }
        }
        
        // Generar examen
        async function generateTest(examId) {
            const exam = teachers[currentTeacher].exams[examId];
            const questions = exam.questions || [];
            
            if (questions.length === 0) {
                showMessage('No hay preguntas en el examen para generar', 'error', true);
                return;
            }
            
            // Guardar configuraci√≥n
            const startDateInput = document.getElementById(`start-date-${examId}`);
            const endDateInput = document.getElementById(`end-date-${examId}`);
            const questionTimeInput = document.getElementById(`question-time-${examId}`);
            const showRankingsToggle = document.getElementById(`show-rankings-${examId}`);
            
            exam.settings = {
                questionTime: parseInt(questionTimeInput.value) || 20,
                startDate: startDateInput.value ? new Date(startDateInput.value).getTime() : null,
                endDate: endDateInput.value ? new Date(endDateInput.value).getTime() : null,
                showRankings: showRankingsToggle.checked
            };
            
            exam.code = generateRandomCode();
            exam.participants = [];
            
            await saveTeachersToGist(teachers);
            document.getElementById(`test-code-${examId}`).textContent = `C√ìDIGO: ${exam.code}`;
            updateParticipantsList(examId);
            updateRankings(examId);
            
            showMessage('¬°Examen generado exitosamente! Comparte este c√≥digo con tus alumnos.', 'success', true);
        }
        
        // Generar c√≥digo aleatorio
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Actualizar lista de participantes
        function updateParticipantsList(examId) {
            const exam = teachers[currentTeacher].exams[examId];
            const participants = exam.participants || [];
            const participantsList = document.getElementById(`participants-list-${examId}`);
            
            if (participants.length === 0) {
                participantsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No hay participantes a√∫n</p>';
                return;
            }
            
            participantsList.innerHTML = '';
            participants.forEach(participant => {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-item';
                const startTime = new Date(participant.startTime).toLocaleString();
                participantDiv.innerHTML = `
                    <div class="participant-name">${participant.name}</div>
                    <div class="participant-time">Finaliz√≥: ${startTime}</div>
                    <div class="participant-time">Puntuaci√≥n: ${participant.score}/${exam.questions.length} (${participant.percentage}%)</div>
                `;
                participantsList.appendChild(participantDiv);
            });
        }
        
        // Actualizar clasificaci√≥n
        function updateRankings(examId) {
            const exam = teachers[currentTeacher].exams[examId];
            const participants = exam.participants || [];
            const questions = exam.questions || [];
            const rankingsList = document.getElementById(`rankings-list-${examId}`);
            
            if (participants.length === 0 || questions.length === 0) {
                rankingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">Sin clasificaci√≥n a√∫n</p>';
                return;
            }
            
            const completedParticipants = participants.filter(p => p.completed);
            const sortedParticipants = completedParticipants.sort((a, b) => b.score - a.score || b.percentage - a.percentage);
            
            rankingsList.innerHTML = '';
            sortedParticipants.forEach((participant, index) => {
                const rankingDiv = document.createElement('div');
                rankingDiv.className = 'ranking-item';
                rankingDiv.innerHTML = `
                    <div class="ranking-position">${index + 1}</div>
                    <div class="ranking-name">${participant.name}</div>
                    <div class="ranking-score">${participant.score}/${questions.length} (${participant.percentage}%)</div>
                `;
                rankingsList.appendChild(rankingDiv);
            });
        }
        
        // Exportar a CSV
        function exportCSV(examId) {
            const exam = teachers[currentTeacher].exams[examId];
            const participants = exam.participants || [];
            const questions = exam.questions || [];
            
            if (participants.length === 0 || questions.length === 0) {
                showMessage('No hay participantes que hayan finalizado el examen', 'error', true);
                return;
            }
            
            const completedParticipants = participants.filter(p => p.completed);
            if (completedParticipants.length === 0) {
                showMessage('No hay participantes que hayan finalizado el examen', 'error', true);
                return;
            }
            
            // Crear contenido CSV en formato correcto
            let csvContent = '';
            
            // Encabezados (primera fila)
            csvContent += 'Nombre,Calificaci√≥n,Puntuaci√≥n,';
            for (let i = 0; i < questions.length; i++) {
                csvContent += `P${i + 1},`;
            }
            csvContent = csvContent.slice(0, -1);
            csvContent += '\r\n';
            
            // Datos de cada participante
            for (let participant of completedParticipants) {
                csvContent += `"${participant.name}",`;
                csvContent += `"${participant.percentage}%",`;
                csvContent += `"${participant.score}/${questions.length}",`;
                
                if (participant.answers && participant.answers.length === questions.length) {
                    for (let answer of participant.answers) {
                        csvContent += `"${answer.isCorrect ? 'Correcto' : 'Incorrecto'}",`;
                    }
                } else {
                    for (let i = 0; i < questions.length; i++) {
                        csvContent += '"-",';
                    }
                }
                csvContent = csvContent.slice(0, -1);
                csvContent += '\r\n';
            }
            
            // Crear y descargar archivo
            const blob = new Blob(['\ufeff', csvContent], { 
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `resultados_examen_${exam.name.replace(/\s+/g, '_')}_${exam.code}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage('Archivo CSV exportado exitosamente', 'success', true);
        }
        
        // Acceso del alumno al examen
        accessTestBtn.addEventListener('click', async () => {
            const code = accessCodeInput.value.trim().toUpperCase();
            studentName = studentNameInput.value.trim();
            
            if (!studentName) {
                showMessage('Por favor ingresa tu nombre', 'error');
                return;
            }
            
            if (!code) {
                showMessage('Por favor ingresa un c√≥digo', 'error');
                return;
            }
            
            // Buscar examen por c√≥digo en TODOS los docentes
            let foundExam = null;
            let foundTeacherEmail = null;
            let foundExamId = null;
            
            // Recargar datos para asegurar que est√°n actualizados
            teachers = await loadTeachersFromGist();
            
            for (const teacherEmail in teachers) {
                const teacher = teachers[teacherEmail];
                if (teacher.exams) {
                    for (const examId in teacher.exams) {
                        const exam = teacher.exams[examId];
                        if (exam.code === code) {
                            foundExam = exam;
                            foundTeacherEmail = teacherEmail;
                            foundExamId = examId;
                            break;
                        }
                    }
                }
                if (foundExam) break;
            }
            
            if (!foundExam) {
                showMessage('C√≥digo incorrecto. Verifica e intenta nuevamente.', 'error');
                return;
            }
            
            // Verificar fechas
            const now = new Date().getTime();
            if (foundExam.settings.startDate && now < foundExam.settings.startDate) {
                showMessage('El examen a√∫n no ha comenzado', 'error');
                return;
            }
            
            if (foundExam.settings.endDate && now > foundExam.settings.endDate) {
                showMessage('El examen ya ha finalizado', 'error');
                return;
            }
            
            if (foundExam.questions.length === 0) {
                showMessage('Este examen no tiene preguntas', 'error');
                return;
            }
            
            // Inicializar para el examen
            currentQuestionIndex = 0;
            studentAnswers = Array(foundExam.questions.length).fill(null);
            questionsBank[foundExamId] = foundExam.questions;
            testSettings = foundExam.settings;
            currentExam = foundExamId;
            
            showQuestion(currentQuestionIndex);
            testInterface.classList.remove('hidden');
            answersSection.classList.remove('active');
            messageArea.innerHTML = '';
        });
        
        // Mostrar pregunta
        function showQuestion(index) {
            if (!currentExam || !questionsBank[currentExam]) {
                showMessage('Error al cargar el examen', 'error');
                return;
            }
            
            const questions = questionsBank[currentExam];
            if (index >= questions.length) {
                processTestResults();
                return;
            }
            
            const question = questions[index];
            const totalQuestions = questions.length;
            
            questionNumber.textContent = `PREGUNTA ${index + 1}`;
            currentQuestionText.textContent = question.question;
            progressIndicator.textContent = `Pregunta ${index + 1} de ${totalQuestions}`;
            
            const isMultiple = question.correctAnswers.length > 1;
            if (isMultiple) {
                typeHint.innerHTML = '<div class="multiple-hint">üí° Puedes seleccionar m√∫ltiples respuestas</div>';
            } else {
                typeHint.innerHTML = '<div class="single-hint">üí° Selecciona solo una respuesta</div>';
            }
            
            studentOptionsContainer.innerHTML = '';
            question.options.forEach((option, optionIndex) => {
                const optionCard = document.createElement('div');
                optionCard.className = 'option-card';
                optionCard.setAttribute('data-option', option);
                
                const inputId = `opt_${index}_${optionIndex}`;
                const inputType = isMultiple ? 'checkbox' : 'radio';
                const inputName = isMultiple ? '' : `question_${index}`;
                
                optionCard.innerHTML = `
                    <input type="${inputType}" 
                           id="${inputId}" 
                           name="${inputName}" 
                           class="option-input" 
                           data-option="${option}">
                    <label for="${inputId}" class="option-label">${option}</label>
                `;
                
                optionCard.addEventListener('click', (e) => {
                    if (e.target !== optionCard.querySelector('.option-input')) {
                        const checkbox = optionCard.querySelector('.option-input');
                        if (isMultiple) {
                            checkbox.checked = !checkbox.checked;
                        } else {
                            const radioButtons = document.querySelectorAll(`input[name="question_${index}"]`);
                            radioButtons.forEach(rb => rb.checked = false);
                            checkbox.checked = true;
                        }
                        updateCardSelection(optionCard, checkbox.checked);
                    }
                });
                
                const input = optionCard.querySelector('.option-input');
                input.addEventListener('change', () => {
                    updateCardSelection(optionCard, input.checked);
                });
                
                studentOptionsContainer.appendChild(optionCard);
            });
            
            startQuestionTimer(question.time || testSettings.questionTime);
        }
        
        // Procesar resultados
        async function processTestResults() {
            if (!currentExam || !questionsBank[currentExam]) {
                showMessage('Error al procesar resultados', 'error');
                return;
            }
            
            const questions = questionsBank[currentExam];
            let correctCount = 0;
            const detailedAnswers = [];
            
            for (let i = 0; i < questions.length; i++) {
                const answer = studentAnswers[i];
                const isCorrect = answer && answer.isCorrect;
                if (isCorrect) correctCount++;
                
                detailedAnswers.push({
                    question: questions[i].question,
                    selected: answer ? (answer.selected || []) : [],
                    correct: questions[i].correctAnswers,
                    isCorrect: isCorrect
                });
            }
            
            const percentage = questions.length > 0 ? Math.round((correctCount / questions.length) * 100) : 0;
            const score = correctCount;
            
            // Registrar participante
            const participant = {
                name: studentName,
                startTime: new Date().getTime(),
                answers: detailedAnswers,
                score: score,
                percentage: percentage,
                completed: true
            };
            
            // Guardar en el examen correspondiente
            let foundTeacher = null;
            for (const teacherEmail in teachers) {
                if (teachers[teacherEmail].exams && teachers[teacherEmail].exams[currentExam]) {
                    foundTeacher = teacherEmail;
                    break;
                }
            }
            
            if (foundTeacher) {
                if (!teachers[foundTeacher].exams[currentExam].participants) {
                    teachers[foundTeacher].exams[currentExam].participants = [];
                }
                teachers[foundTeacher].exams[currentExam].participants.push(participant);
                await saveTeachersToGist(teachers);
                
                // Actualizar vistas del docente si est√° abierto
                if (currentTeacher === foundTeacher && expandedExam === currentExam) {
                    updateParticipantsList(currentExam);
                    updateRankings(currentExam);
                }
            }
            
            // Mostrar resultados al alumno
            testInterface.classList.add('hidden');
            displayStudentResults(detailedAnswers, score, percentage, questions.length);
        }
        
        // Mostrar resultados al alumno
        function displayStudentResults(answers, score, percentage, totalQuestions) {
            answersList.innerHTML = '';
            
            answers.forEach((answer, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-item';
                
                const selectedHtml = answer.selected.length > 0 ? 
                    answer.selected.map(opt => `<strong>${opt}</strong>`).join(', ') : 
                    '<em>Sin respuesta</em>';
                const correctHtml = answer.correct.map(opt => `<span style="color: #38a169; font-weight: bold;">${opt}</span>`).join(', ');
                
                const resultClass = answer.isCorrect ? 'correct' : 'incorrect';
                const resultText = answer.isCorrect ? '‚úÖ Correcto' : '‚ùå Incorrecto';
                
                answerDiv.innerHTML = `
                    <div class="answer-header">
                        <div class="answer-question-number">PREGUNTA ${index + 1}</div>
                        <div class="answer-result ${resultClass}">${resultText}</div>
                    </div>
                    <div class="answer-content">
                        <p><strong>Pregunta:</strong> ${answer.question}</p>
                        <p><strong>Tu respuesta:</strong> ${selectedHtml}</p>
                        <p><strong>Respuesta correcta:</strong> ${correctHtml}</p>
                    </div>
                `;
                answersList.appendChild(answerDiv);
            });
            
            testResult.innerHTML = `
                <h4>üìä Resultado Final</h4>
                <div class="test-percentage">${percentage}%</div>
                <p>Preguntas correctas: <strong>${score}</strong> de <strong>${totalQuestions}</strong></p>
            `;
            
            answersSection.classList.add('active');
            
            // Mostrar clasificaci√≥n si est√° activada
            if (testSettings.showRankings) {
                studentRankingsSection.classList.remove('hidden');
                updateStudentRankings(totalQuestions);
            }
        }
        
        // Actualizar clasificaci√≥n para el alumno
        function updateStudentRankings(totalQuestions) {
            if (!currentExam) {
                studentRankingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">Sin clasificaci√≥n a√∫n</p>';
                return;
            }
            
            // Buscar el examen
            let exam = null;
            let foundTeacher = null;
            for (const teacherEmail in teachers) {
                if (teachers[teacherEmail].exams && teachers[teacherEmail].exams[currentExam]) {
                    exam = teachers[teacherEmail].exams[currentExam];
                    foundTeacher = teacherEmail;
                    break;
                }
            }
            
            if (!exam || !exam.participants) {
                studentRankingsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">Sin clasificaci√≥n a√∫n</p>';
                return;
            }
            
            const completedParticipants = exam.participants.filter(p => p.completed);
            const sortedParticipants = completedParticipants.sort((a, b) => b.score - a.score || b.percentage - a.percentage);
            
            studentRankingsList.innerHTML = '';
            sortedParticipants.forEach((participant, index) => {
                const rankingDiv = document.createElement('div');
                rankingDiv.className = 'ranking-item';
                rankingDiv.innerHTML = `
                    <div class="ranking-position">${index + 1}</div>
                    <div class="ranking-name">${participant.name}</div>
                    <div class="ranking-score">${participant.score}/${totalQuestions} (${participant.percentage}%)</div>
                `;
                studentRankingsList.appendChild(rankingDiv);
            });
        }
        
        // Temporizador
        function startQuestionTimer(seconds) {
            if (questionTimer) {
                clearInterval(questionTimer);
            }
            
            let remaining = seconds;
            updateTimerDisplay(remaining);
            
            questionTimer = setInterval(() => {
                remaining--;
                updateTimerDisplay(remaining);
                
                if (remaining <= 0) {
                    clearInterval(questionTimer);
                    autoSubmitQuestion();
                }
                
                if (remaining <= 5) {
                    timerDisplay.classList.add('timer-warning');
                }
            }, 1000);
        }
        
        function updateTimerDisplay(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timerDisplay.textContent = `Tiempo restante: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function autoSubmitQuestion() {
            if (!currentExam || !questionsBank[currentExam] || currentQuestionIndex >= questionsBank[currentExam].length) {
                return;
            }
            
            const question = questionsBank[currentExam][currentQuestionIndex];
            const isMultiple = question.correctAnswers.length > 1;
            
            const selectedOptions = [];
            const optionCards = studentOptionsContainer.querySelectorAll('.option-card');
            
            optionCards.forEach(card => {
                const input = card.querySelector('.option-input');
                if (input.checked) {
                    selectedOptions.push(input.getAttribute('data-option'));
                }
            });
            
            const isCorrect = selectedOptions.length > 0 ? compareArrays(selectedOptions, question.correctAnswers) : false;
            
            studentAnswers[currentQuestionIndex] = {
                question: question.question,
                selected: selectedOptions,
                correct: question.correctAnswers,
                isCorrect: isCorrect
            };
            
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        }
        
        function updateCardSelection(card, isSelected) {
            if (isSelected) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }
        
        submitButton.addEventListener('click', () => {
            if (!currentExam || !questionsBank[currentExam] || currentQuestionIndex >= questionsBank[currentExam].length) {
                return;
            }
            
            const question = questionsBank[currentExam][currentQuestionIndex];
            const isMultiple = question.correctAnswers.length > 1;
            
            const selectedOptions = [];
            const optionCards = studentOptionsContainer.querySelectorAll('.option-card');
            
            optionCards.forEach(card => {
                const input = card.querySelector('.option-input');
                if (input.checked) {
                    selectedOptions.push(input.getAttribute('data-option'));
                }
            });
            
            if (selectedOptions.length === 0) {
                showMessage('Por favor selecciona al menos una respuesta', 'error');
                return;
            }
            
            const isCorrect = compareArrays(selectedOptions, question.correctAnswers);
            
            studentAnswers[currentQuestionIndex] = {
                question: question.question,
                selected: selectedOptions,
                correct: question.correctAnswers,
                isCorrect: isCorrect
            };
            
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        });
        
        function compareArrays(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            const sorted1 = [...arr1].sort();
            const sorted2 = [...arr2].sort();
            return sorted1.every((value, index) => value === sorted2[index]);
        }
        
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Inicializar la aplicaci√≥n
        (async function init() {
            try {
                // Cargar datos desde Gist
                teachers = await loadTeachersFromGist();
                
                // Verificar si hay datos iniciales
                if (Object.keys(teachers).length === 0) {
                    // Crear datos de ejemplo si no existen
                    teachers['profesor@ejemplo.com'] = {
                        email: 'profesor@ejemplo.com',
                        password: '123456',
                        exams: {}
                    };
                    await saveTeachersToGist(teachers);
                }
                
                // Eliminar el loading
                examsList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">No tienes ex√°menes creados</p>';
                
            } catch (error) {
                console.error('Error al inicializar:', error);
                examsList.innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 10px;">Error al cargar los datos</p>';
                showMessage('No se pudieron cargar los datos. Verifica tu conexi√≥n.', 'error');
            }
        })();
        </script>
    </body>
</html>

